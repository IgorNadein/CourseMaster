{% extends "profiles/base.html" %}
{% load static %}

{% block title %}–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∞ - CourseMaster{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row">
        <div class="col-lg-8 offset-lg-2">
            <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç —Ç–µ—Å—Ç–∞ -->
            <div class="card mb-4 border-0 shadow-sm">
                <div class="card-body text-center">
                    {% if attempt.is_passed %}
                    <div class="alert alert-success mb-3">
                        <i class="bi bi-check-circle" style="font-size: 2rem;"></i>
                        <h3 class="mt-2">üéâ –¢–µ—Å—Ç –ø—Ä–æ–π–¥–µ–Ω!</h3>
                    </div>
                    {% else %}
                    <div class="alert alert-danger mb-3">
                        <i class="bi bi-x-circle" style="font-size: 2rem;"></i>
                        <h3 class="mt-2">‚ùå –¢–µ—Å—Ç –Ω–µ –ø—Ä–æ–π–¥–µ–Ω</h3>
                    </div>
                    {% endif %}

                    <h2 class="mb-4">{{ attempt.quiz.title }}</h2>

                    <!-- –û—Å–Ω–æ–≤–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card border-0 bg-light">
                                <div class="card-body">
                                    <p class="text-muted mb-1">–í–∞—à —Ä–µ–∑—É–ª—å—Ç–∞—Ç</p>
                                    <h3 class="mb-0">{{ attempt.percentage|floatformat:1 }}%</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card border-0 bg-light">
                                <div class="card-body">
                                    <p class="text-muted mb-1">–ë–∞–ª–ª—ã</p>
                                    <h3 class="mb-0">{{ attempt.score }}/{{ attempt.total_points }}</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card border-0 bg-light">
                                <div class="card-body">
                                    <p class="text-muted mb-1">–ü—Ä–æ—Ö–æ–¥–Ω–æ–π –±–∞–ª–ª</p>
                                    <h3 class="mb-0">{{ attempt.quiz.pass_percentage }}%</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card border-0 bg-light">
                                <div class="card-body">
                                    <p class="text-muted mb-1">–î–∞—Ç–∞</p>
                                    <small>{{ attempt.completed_at|date:"d.m.Y H:i" }}</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä -->
                    <div class="mb-4">
                        <div class="progress" style="height: 30px;">
                            <div class="progress-bar {% if attempt.is_passed %}bg-success{% else %}bg-danger{% endif %}" 
                                 role="progressbar" 
                                 style="width: {{ attempt.percentage }}%"
                                 aria-valuenow="{{ attempt.percentage }}" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                                {{ attempt.percentage|floatformat:1 }}%
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –î–µ—Ç–∞–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã -->
            {% if show_answers %}
            <div class="card mb-4 border-0 shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0">–í–∞—à–∏ –æ—Ç–≤–µ—Ç—ã</h5>
                </div>
                <div class="card-body">
                    {% for answer in answers %}
                    <div class="card mb-3 border-{% if answer.is_correct %}success{% elif answer.is_correct == False %}danger{% else %}warning{% endif %}">
                        <div class="card-header bg-light d-flex justify-content-between align-items-center">
                            <strong>–í–æ–ø—Ä–æ—Å {{ forloop.counter }}: {{ answer.question.text }}</strong>
                            {% if answer.is_correct %}
                                <span class="badge bg-success">‚úì –ü—Ä–∞–≤–∏–ª—å–Ω–æ</span>
                            {% elif answer.is_correct == False %}
                                <span class="badge bg-danger">‚úó –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ</span>
                            {% else %}
                                <span class="badge bg-warning">‚è≥ –ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ</span>
                            {% endif %}
                        </div>
                        <div class="card-body">
                            {% if answer.choice %}
                                <p class="mb-2"><strong>–í–∞—à –æ—Ç–≤–µ—Ç:</strong> {{ answer.choice.text }}</p>
                            {% elif answer.text_answer %}
                                <p class="mb-2"><strong>–í–∞—à –æ—Ç–≤–µ—Ç:</strong> {{ answer.text_answer }}</p>
                            {% else %}
                                <p class="mb-2 text-muted"><em>–û—Ç–≤–µ—Ç –Ω–µ –¥–∞–Ω</em></p>
                            {% endif %}

                            {% if answer.question.type != 'text' %}
                                <p class="mb-0"><strong>–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç:</strong></p>
                                <ul class="mb-0">
                                    {% for choice in answer.question.choices.all %}
                                        {% if choice.is_correct %}
                                        <li class="text-success"><strong>{{ choice.text }}</strong></li>
                                        {% endif %}
                                    {% endfor %}
                                </ul>
                            {% endif %}

                            {% if answer.question.explanation %}
                            <div class="alert alert-info mt-3 mb-0">
                                <strong>–û–±—ä—è—Å–Ω–µ–Ω–∏–µ:</strong> {{ answer.question.explanation }}
                            </div>
                            {% endif %}

                            {% if answer.points_earned %}
                            <p class="mt-3 mb-0">
                                <strong class="text-success">+{{ answer.points_earned }} –±–∞–ª–ª–æ–≤</strong>
                            </p>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫—É—Ä—Å–µ -->
            <div class="card mb-4 border-0 shadow-sm">
                <div class="card-body">
                    <p class="mb-2"><strong>–ö—É—Ä—Å:</strong> {{ course.title }}</p>
                    <p class="mb-2"><strong>–£—Ä–æ–∫:</strong> {{ lesson.title }}</p>
                    <p class="mb-0"><strong>–ü–æ–ø—ã—Ç–æ–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ:</strong> {{ attempt.quiz.quizattempt_set.count }}</p>
                </div>
            </div>

            <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                <a href="{% url 'lesson_view' lesson.id %}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> –ù–∞–∑–∞–¥ –∫ —É—Ä–æ–∫—É
                </a>
                {% if attempt.quiz.quizattempt_set.count < attempt.quiz.attempts_limit %}
                <a href="{% url 'quiz_take' attempt.quiz.id %}" class="btn btn-primary">
                    <i class="bi bi-arrow-repeat"></i> –ü—Ä–æ–π—Ç–∏ —Ç–µ—Å—Ç –∑–∞–Ω–æ–≤–æ
                </a>
                {% else %}
                <button type="button" class="btn btn-secondary" disabled>
                    –ü–æ–ø—ã—Ç–∫–∏ –∏—Å—á–µ—Ä–ø–∞–Ω—ã
                </button>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

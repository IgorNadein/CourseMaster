# Changelog: –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è –ø–µ—Ä–µ–¥–µ–ª–∫–∞ –ª–æ–≥–∏–∫–∏ Single-Choice (–æ–¥–∏–Ω–æ—á–Ω—ã–π –≤—ã–±–æ—Ä)

**–î–∞—Ç–∞:** 27 –¥–µ–∫–∞–±—Ä—è 2025  
**–í–µ—Ä—Å–∏—è:** v1.0.2 (Architecture Fix)  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–ê–í–ï–†–®–ï–ù–û  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ CRITICAL (Security & Data Integrity)

---

## üìã –ü—Ä–æ–±–ª–µ–º–∞

**–û—à–∏–±–∫–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã:** –õ–æ–≥–∏–∫–∞ "—Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç" –±—ã–ª–∞ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —Ç–æ–ª—å–∫–æ –≤ AJAX views, –Ω–æ **–Ω–µ –Ω–∞ —É—Ä–æ–≤–Ω–µ –º–æ–¥–µ–ª–∏**.

### –°–∏–º–ø—Ç–æ–º—ã
```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç "–æ–¥–∏–Ω–æ—á–Ω—ã–π –≤—ã–±–æ—Ä" (single-choice)
2. –£–∫–∞–∑—ã–≤–∞–µ—Ç –≤–∞—Ä–∏–∞–Ω—Ç –ê –∫–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π ‚úì
3. –£–∫–∞–∑—ã–≤–∞–µ—Ç –≤–∞—Ä–∏–∞–Ω—Ç –ë –∫–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π ‚úì
4. –í –ë–î —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –û–ë–ê –∫–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ ‚ùå
```

### –ü–æ—á–µ–º—É —ç—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ

**–î–æ (Vulnerable):**
```python
# ‚ùå –õ–æ–≥–∏–∫–∞ —Ç–æ–ª—å–∫–æ –≤ ChoiceUpdateAjaxView
if value and choice.question.type == 'single':
    choice.question.choices.exclude(id=choice_id).update(is_correct=False)
```

**–ü—Ä–æ–±–ª–µ–º—ã —ç—Ç–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞:**
1. –ú–æ–∂–Ω–æ –æ–±–æ–π—Ç–∏ —á–µ—Ä–µ–∑ admin panel ‚Üí —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ `is_correct=True`
2. –ú–æ–∂–Ω–æ –æ–±–æ–π—Ç–∏ —á–µ—Ä–µ–∑ –ø—Ä—è–º–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤ –ë–î
3. –ú–æ–∂–Ω–æ –æ–±–æ–π—Ç–∏ —á–µ—Ä–µ–∑ –¥—Ä—É–≥–æ–π AJAX endpoint (–µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å)
4. –õ–æ–≥–∏–∫–∞ —Ä–∞–∑–Ω–µ—Å–µ–Ω–∞ –ø–æ —Ä–∞–∑–Ω—ã–º –º–µ—Å—Ç–∞–º –∫–æ–¥–∞
5. –ù–∞—Ä—É—à–∞–µ—Ç—Å—è –ø—Ä–∏–Ω—Ü–∏–ø **DRY** (Don't Repeat Yourself)

---

## ‚úÖ –†–µ—à–µ–Ω–∏–µ: Model-Level Validation

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π –ø—Ä–∏–Ω—Ü–∏–ø:** *–í–∞–ª–∏–¥–∞—Ü–∏—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –Ω–∞ —É—Ä–æ–≤–Ω–µ –º–æ–¥–µ–ª–∏*

### –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

#### 1. **QuestionChoice.save() –º–µ—Ç–æ–¥** (models.py)

```python
class QuestionChoice(models.Model):
    question = models.ForeignKey(Question, on_delete=models.CASCADE, related_name='choices')
    text = models.CharField(max_length=500)
    is_correct = models.BooleanField(default=False)
    order = models.PositiveIntegerField(default=0)
    
    def save(self, *args, **kwargs):
        """
        –î–ª—è –≤–æ–ø—Ä–æ—Å–æ–≤ —Å –æ–¥–∏–Ω–æ—á–Ω—ã–º –≤—ã–±–æ—Ä–æ–º (single/true_false):
        –µ—Å–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å is_correct=True, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–Ω–∏–º–∞–µ–º —Ñ–ª–∞–≥ —Å –¥—Ä—É–≥–∏—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤
        """
        if self.is_correct and self.question.type in ['single', 'true_false']:
            # –°–Ω—è—Ç—å is_correct —Å–æ –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ —ç—Ç–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞
            self.question.choices.exclude(pk=self.pk).update(is_correct=False)
        
        super().save(*args, **kwargs)
```

**–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
1. ‚úÖ –ü—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —á–µ—Ä–µ–∑ ORM ‚Üí –ª–æ–≥–∏–∫–∞ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
2. ‚úÖ –ü—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —á–µ—Ä–µ–∑ admin panel ‚Üí –ª–æ–≥–∏–∫–∞ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç
3. ‚úÖ –ü—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —á–µ—Ä–µ–∑ AJAX ‚Üí –ª–æ–≥–∏–∫–∞ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç
4. ‚úÖ –ü—Ä–∏ –ø—Ä—è–º–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –≤ –ë–î (–Ω–µ —á–µ—Ä–µ–∑ save()) ‚Üí –Ω–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç, –Ω–æ —ç—Ç–æ —Ä–µ–¥–∫–æ

### 2. **–£–ø—Ä–æ—â–µ–Ω–∏–µ AJAX views**

–¢–µ–ø–µ—Ä—å AJAX views –ø—Ä–æ—Å—Ç–æ:
1. –í–∞–ª–∏–¥–∏—Ä—É—é—Ç –≤—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
2. –í—ã–∑—ã–≤–∞—é—Ç `choice.save()`
3. –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤ `QuestionChoice.save()`

**–î–æ:**
```python
# ‚ùå –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏
if is_correct and choice.question.type == 'single':
    choice.question.choices.exclude(id=choice_id).update(is_correct=False)
setattr(choice, field, value)
choice.save()
```

**–ü–æ—Å–ª–µ:**
```python
# ‚úÖ –õ–æ–≥–∏–∫–∞ –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ (–º–æ–¥–µ–ª—å)
setattr(choice, field, value)
choice.save()  # –≠—Ç–æ –≤—ã–∑–æ–≤–µ—Ç QuestionChoice.save() —Å –ª–æ–≥–∏–∫–æ–π
```

---

## üîß –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

### 1. `courses/models.py` (QuestionChoice model)
- **–î–æ–±–∞–≤–ª–µ–Ω–æ:** `save()` –º–µ—Ç–æ–¥ —Å –ª–æ–≥–∏–∫–æ–π single-choice
- **–†–∞–∑–º–µ—Ä:** +13 —Å—Ç—Ä–æ–∫

### 2. `courses/ajax_views.py`
- **ChoiceCreateAjaxView:** –£–¥–∞–ª–µ–Ω–∞ –¥—É–±–ª–∏—Ä—É—é—â–∞—è—Å—è –ª–æ–≥–∏–∫–∞
  - **–î–æ:** 43 —Å—Ç—Ä–æ–∫–∏
  - **–ü–æ—Å–ª–µ:** 39 —Å—Ç—Ä–æ–∫
  - **–£–¥–∞–ª–µ–Ω–æ:** 4 —Å—Ç—Ä–æ–∫–∏ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è

- **ChoiceUpdateAjaxView:** –£–ø—Ä–æ—â–µ–Ω–∞ –ª–æ–≥–∏–∫–∞
  - **–î–æ:** 45 —Å—Ç—Ä–æ–∫  
  - **–ü–æ—Å–ª–µ:** 40 —Å—Ç—Ä–æ–∫
  - **–£–ª—É—á—à–µ–Ω–æ:** –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è string‚Üíbool –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏

---

## üìä –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –î–æ | –ü–æ—Å–ª–µ |
|----------|-----|-------|
| **–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ—Å—Ç —Å –ª–æ–≥–∏–∫–æ–π** | 2 (create, update) | 1 (–º–æ–¥–µ–ª—å) |
| **–°–ø–æ—Å–æ–±—ã –æ–±—Ö–æ–¥–∞** | 3+ (admin, direct SQL, etc) | ~0 (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è ORM) |
| **–õ–µ–≥–∫–æ—Å—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫–∏** | –°–ª–æ–∂–Ω–æ (—Ä–∞–∑–Ω–µ—Å–µ–Ω–æ) | –õ–µ–≥–∫–æ (–≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ) |
| **–¢–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å** | –°–ª–æ–∂–Ω–æ | –ü—Ä–æ—Å—Ç–æ (—é–Ω–∏—Ç-—Ç–µ—Å—Ç—ã –Ω–∞ –º–æ–¥–µ–ª—å) |
| **DRY –ø—Ä–∏–Ω—Ü–∏–ø** | ‚ùå –ù–∞—Ä—É—à–µ–Ω | ‚úÖ –°–æ–±–ª—é–¥–∞–µ—Ç—Å—è |

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### Test Case 1: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–µ—Ä–≤–æ–≥–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
```python
# –í–æ–ø—Ä–æ—Å —Å 4 –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏
question = Question.objects.create(type='single', ...)
choice_a = QuestionChoice.objects.create(question=question, text='A', is_correct=False)
choice_b = QuestionChoice.objects.create(question=question, text='B', is_correct=False)

# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å A –∫–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π
choice_a.is_correct = True
choice_a.save()

# –ü—Ä–æ–≤–µ—Ä–∫–∞
assert choice_a.is_correct == True  # ‚úÖ A –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π
assert choice_b.is_correct == False  # ‚úÖ B –±–æ–ª—å—à–µ –Ω–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π
```

### Test Case 2: –°–º–µ–Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
```python
choice_a.is_correct = False
choice_a.save()

choice_b.is_correct = True
choice_b.save()

assert choice_a.is_correct == False  # ‚úÖ
assert choice_b.is_correct == True   # ‚úÖ
assert choice_c.is_correct == False  # ‚úÖ (–±—ã–ª)
```

### Test Case 3: Multiple-choice –Ω–µ –∑–∞—Ç—Ä–∞–≥–∏–≤–∞–µ—Ç—Å—è
```python
question = Question.objects.create(type='multiple', ...)
choice_x = QuestionChoice.objects.create(question=question, text='X', is_correct=False)
choice_y = QuestionChoice.objects.create(question=question, text='Y', is_correct=False)

choice_x.is_correct = True
choice_x.save()

choice_y.is_correct = True
choice_y.save()

assert choice_x.is_correct == True   # ‚úÖ –û–±–µ –æ—Å—Ç–∞—é—Ç—Å—è True
assert choice_y.is_correct == True   # ‚úÖ (multiple-choice –ø–æ–∑–≤–æ–ª—è–µ—Ç)
```

### Test Case 4: Admin panel
```
1. –û—Ç–∫—Ä—ã—Ç—å QuestionChoice –≤ admin
2. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å is_correct=True –¥–ª—è –≤–∞—Ä–∏–∞–Ω—Ç–∞ A
3. –ù–∞–∂–∞—Ç—å Save
4. ‚Üí –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–±—Ä–æ—Å—è—Ç—Å—è –Ω–∞ is_correct=False
```

---

## üõ°Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –ü–æ–∫—Ä—ã—Ç–∏–µ –∞—Ç–∞–∫

| –ê—Ç–∞–∫–∞ | –°—Ç–∞—Ç—É—Å |
|-------|--------|
| –ù–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö —á–µ—Ä–µ–∑ AJAX | ‚úÖ –ó–∞–∫—Ä—ã—Ç–∞ (–º–æ–¥–µ–ª—å.save()) |
| –ù–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö —á–µ—Ä–µ–∑ Admin | ‚úÖ –ó–∞–∫—Ä—ã—Ç–∞ (–º–æ–¥–µ–ª—å.save()) |
| –ù–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö —á–µ—Ä–µ–∑ SQL | ‚ö†Ô∏è –í–æ–∑–º–æ–∂–Ω–∞ (—Ç—Ä–µ–±—É–µ—Ç –ø—Ä—è–º–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è) |
| Race condition | ‚ö†Ô∏è –í–æ–∑–º–æ–∂–Ω–∞ (–Ω—É–∂–Ω–∞ database-level constraint) |

### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞ (Future)

–î–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –∑–∞—â–∏—Ç—ã —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å **database-level constraint**:

```python
# –í –º–∏–≥—Ä–∞—Ü–∏–∏
class Meta:
    constraints = [
        # –î–ª—è single-choice: –º–∞–∫—Å 1 is_correct=True
        models.CheckConstraint(
            check=Q(question__type='single') | ~Q(is_correct=True),
            name='single_choice_one_correct'
        ),
    ]
```

---

## üìà –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

### Django Check
```bash
$ python manage.py check
System check identified no issues (0 silenced).
‚úÖ No errors
```

### –í–∞–ª–∏–¥–∞—Ü–∏—è
‚úÖ –õ–æ–≥–∏–∫–∞ –Ω–∞ —É—Ä–æ–≤–Ω–µ –º–æ–¥–µ–ª–∏  
‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∏ –ª—é–±–æ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏  
‚úÖ –ü—Ä–æ—Å—Ç–æ–π –∏ –ø–æ–Ω—è—Ç–Ω—ã–π –∫–æ–¥  
‚úÖ –õ–µ–≥–∫–æ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è  

---

## üéì –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π —É—Ä–æ–∫

### –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –∏–µ—Ä–∞—Ä—Ö–∏—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏

```
1. –£—Ä–æ–≤–µ–Ω—å –ë–î (constraints, triggers) - –ù–ê–î–ï–ñ–ù–û
   ‚îî‚îÄ –ï—Å–ª–∏ –Ω–∞—Ä—É—à–∏—Ç—å –Ω–∞–ø—Ä—è–º—É—é –≤ –ë–î, —Å–∏—Å—Ç–µ–º–∞ —Å–ª–æ–º–∞–µ—Ç—Å—è

2. –£—Ä–æ–≤–µ–Ω—å –º–æ–¥–µ–ª–∏ (save(), clean()) - –ë–ï–ó–û–ü–ê–°–ù–û
   ‚îî‚îÄ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–µ–∑–¥–µ, –≥–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è ORM

3. –£—Ä–æ–≤–µ–Ω—å view (AJAX, forms) - –£–î–û–ë–ù–û
   ‚îî‚îÄ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –æ—à–∏–±–∫–∏, –∫—Ä–∞—Å–∏–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è

4. –£—Ä–æ–≤–µ–Ω—å frontend (JavaScript) - –ë–´–°–¢–†–û
   ‚îî‚îÄ –ë—ã—Å—Ç—Ä–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å, –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
```

**–ü—Ä–∏–Ω—Ü–∏–ø:** –í–∞–ª–∏–¥–∞—Ü–∏—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å **–∫–∞–∫ –º–æ–∂–Ω–æ –±–ª–∏–∂–µ –∫ –¥–∞–Ω–Ω—ã–º** (–≤ –º–æ–¥–µ–ª–∏), –Ω–µ –≤ views!

---

**–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è:** 27 –¥–µ–∫–∞–±—Ä—è 2025  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ Production Ready  
**–¢—Ä–µ–±—É–µ—Ç –º–∏–≥—Ä–∞—Ü–∏–∏:** ‚ùå –ù–µ—Ç (–ª–æ–≥–∏–∫–∞, –Ω–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞)

{% extends 'base.html' %}
{% load static %}

{% block title %}{{ course.title }} - CourseMaster{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/courses.css' %}">
{% endblock %}

{% block body_content %}
<!-- Hero —Å–µ–∫—Ü–∏—è –∫—É—Ä—Å–∞ -->
<div class="course-hero">
    <div class="container">
        <div class="course-hero-content">
            <!-- –•–ª–µ–±–Ω—ã–µ –∫—Ä–æ—à–∫–∏ -->
            <nav class="breadcrumb">
                <a href="{% url 'home' %}">–ì–ª–∞–≤–Ω–∞—è</a> /
                <a href="{% url 'course_list' %}">–ö—É—Ä—Å—ã</a>
                {% if course.category %}
                / <a href="{% url 'course_list' %}?category={{ course.category.slug }}">{{ course.category.name }}</a>
                {% endif %}
            </nav>
            
            <h1>{{ course.title }}</h1>
            {% if course.subtitle %}
            <p class="course-hero-subtitle">{{ course.subtitle }}</p>
            {% endif %}
            
            <div class="course-hero-meta">
                <span class="badge badge-level">{{ course.get_level_display }}</span>
                {% if course.category %}
                <span>{{ course.category.icon }} {{ course.category.name }}</span>
                {% endif %}
                <span class="course-rating">
                    <span class="course-rating-stars">‚òÖ {{ avg_rating|floatformat:1 }}</span>
                    ({{ total_reviews }} –æ—Ç–∑—ã–≤–æ–≤)
                </span>
                <span>{{ course.students_count }} —Å—Ç—É–¥–µ–Ω—Ç–æ–≤</span>
                <span>{{ course.duration_hours }} —á–∞—Å–æ–≤</span>
            </div>
            
            <p class="course-instructor">
                –ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å: <strong>{{ course.instructor.get_full_name|default:course.instructor.username }}</strong>
            </p>
        </div>
    </div>
</div>

<div class="container">
    <div class="course-layout">
        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
        <div class="course-main">
            <!-- –û–ø–∏—Å–∞–Ω–∏–µ -->
            <div class="course-section">
                <h2>–û–ø–∏—Å–∞–Ω–∏–µ –∫—É—Ä—Å–∞</h2>
                <div class="course-description">
                    {{ course.description|linebreaks }}
                </div>
            </div>
            
            <!-- –ß—Ç–æ –≤—ã –∏–∑—É—á–∏—Ç–µ -->
            {% if course.learning_outcomes %}
            <div class="course-section">
                <h2>–ß—Ç–æ –≤—ã –∏–∑—É—á–∏—Ç–µ</h2>
                <ul class="course-outcomes">
                    {% for line in course.learning_outcomes.splitlines %}
                    {% if line.strip %}
                    <li>‚úì {{ line }}</li>
                    {% endif %}
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
            
            <!-- –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è -->
            {% if course.requirements %}
            <div class="course-section">
                <h2>–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è</h2>
                <ul class="course-requirements">
                    {% for line in course.requirements.splitlines %}
                    {% if line.strip %}
                    <li>‚Ä¢ {{ line }}</li>
                    {% endif %}
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
            
            <!-- –ü—Ä–æ–≥—Ä–∞–º–º–∞ –∫—É—Ä—Å–∞ -->
            <div class="course-section">
                <h2>–ü—Ä–æ–≥—Ä–∞–º–º–∞ –∫—É—Ä—Å–∞</h2>
                <p class="course-section-meta">{{ sections|length }} –º–æ–¥—É–ª–µ–π ‚Ä¢ {{ total_lessons }} —É—Ä–æ–∫–æ–≤ ‚Ä¢ {{ total_duration }} –º–∏–Ω</p>
                
                {% for section in sections %}
                <div class="course-section-accordion">
                    <div class="course-section-header" onclick="toggleAccordion(this)">
                        <span class="course-section-title">{{ section.title }}</span>
                        <span class="course-section-meta">{{ section.lessons.count }} —É—Ä–æ–∫–æ–≤</span>
                    </div>
                    <ul class="course-lesson-list" style="display: none;">
                        {% for lesson in section.lessons.all %}
                        <li class="course-lesson-item">
                            {% if is_enrolled or lesson.is_preview %}
                            <a href="{% url 'lesson_view' lesson.id %}" class="course-lesson-link">
                                <span>
                                    <span class="course-lesson-icon">
                                        {% if lesson.lesson_type == 'video' %}üé•
                                        {% elif lesson.lesson_type == 'article' %}üìÑ
                                        {% elif lesson.lesson_type == 'quiz' %}‚ùì
                                        {% elif lesson.lesson_type == 'assignment' %}‚úèÔ∏è
                                        {% endif %}
                                    </span>
                                    {{ lesson.title }}
                                    {% if lesson.is_preview %}<span class="badge badge-free">–ü—Ä–µ–≤—å—é</span>{% endif %}
                                </span>
                                <span class="course-lesson-duration">{{ lesson.duration_minutes }} –º–∏–Ω</span>
                            </a>
                            {% else %}
                            <span class="course-lesson-locked">
                                <span>
                                    <span class="course-lesson-icon">üîí</span>
                                    {{ lesson.title }}
                                </span>
                                <span class="course-lesson-duration">{{ lesson.duration_minutes }} –º–∏–Ω</span>
                            </span>
                            {% endif %}
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% empty %}
                <p>–ü—Ä–æ–≥—Ä–∞–º–º–∞ –∫—É—Ä—Å–∞ –ø–æ–∫–∞ –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞.</p>
                {% endfor %}
            </div>
            
            <!-- –û—Ç–∑—ã–≤—ã -->
            <div class="course-section">
                <h2>–û—Ç–∑—ã–≤—ã —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ ({{ reviews_count }})</h2>
                
                {% if reviews %}
                <div class="reviews-list">
                    {% for review in reviews %}
                    <div class="comment">
                        <div class="comment-header">
                            <div class="comment-avatar">{{ review.student.username|slice:":1"|upper }}</div>
                            <div>
                                <div class="comment-author">{{ review.student.get_full_name|default:review.student.username }}</div>
                                <div class="comment-date">{{ review.created_at|date:"d.m.Y" }} ‚Ä¢ ‚òÖ {{ review.rating }}/5</div>
                            </div>
                        </div>
                        <div class="comment-body">
                            {% if review.title %}<strong>{{ review.title }}</strong><br>{% endif %}
                            {{ review.comment }}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                {% if reviews_count > 10 %}
                <a href="{% url 'course_reviews' course.slug %}" class="btn btn-secondary">
                    –í—Å–µ –æ—Ç–∑—ã–≤—ã ({{ reviews_count }})
                </a>
                {% endif %}
                {% else %}
                <p>–ü–æ–∫–∞ –Ω–µ—Ç –æ—Ç–∑—ã–≤–æ–≤. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!</p>
                {% endif %}
                
                {% if user.is_authenticated and is_enrolled %}
                <div class="review-action">
                    {% if user_review %}
                    <a href="{% url 'review_update' course.slug %}" class="btn btn-secondary">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–∑—ã–≤</a>
                    {% else %}
                    <a href="{% url 'review_create' course.slug %}" class="btn btn-primary">–û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</a>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- –°–∞–π–¥–±–∞—Ä -->
        <aside class="course-sidebar">
            <div class="course-sidebar-card">
                <!-- –ü—Ä–µ–≤—å—é -->
                {% if course.thumbnail %}
                <img src="{{ course.thumbnail.url }}" alt="{{ course.title }}" class="course-preview-video">
                {% endif %}
                
                <!-- –¶–µ–Ω–∞ -->
                <div class="course-sidebar-price">
                    {% if course.is_free %}
                    <span style="color: #28a745;">–ë–µ—Å–ø–ª–∞—Ç–Ω–æ</span>
                    {% elif course.has_discount %}
                    <span class="course-price-old">{{ course.price }} ‚ÇΩ</span>
                    {{ course.current_price }} ‚ÇΩ
                    {% else %}
                    {{ course.price }} ‚ÇΩ
                    {% endif %}
                </div>
                
                <!-- –ö–Ω–æ–ø–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è -->
                {% if is_instructor %}
                <a href="{% url 'instructor_course_detail' course.slug %}" class="btn btn-primary">
                    –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫—É—Ä—Å
                </a>
                {% elif is_enrolled %}
                <a href="{% url 'my_courses' %}" class="btn btn-success">
                    –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –æ–±—É—á–µ–Ω–∏–µ
                </a>
                {% if enrollment %}
                <div class="progress-bar">
                    <div class="progress-bar-fill" style="width: {{ progress_percentage }}%;"></div>
                </div>
                <p class="progress-text">–ü—Ä–æ–≥—Ä–µ—Å—Å: {{ progress_percentage|floatformat:0 }}%</p>
                {% endif %}
                {% else %}
                <form method="post" action="{% url 'course_enroll' course.slug %}">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-primary">–ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫—É—Ä—Å</button>
                </form>
                {% endif %}
                
                <!-- –ß—Ç–æ –≤–∫–ª—é—á–µ–Ω–æ -->
                <ul class="course-includes">
                    <li>üé• {{ total_lessons }} —É—Ä–æ–∫–æ–≤</li>
                    <li>‚è±Ô∏è {{ total_duration }} –º–∏–Ω—É—Ç –≤–∏–¥–µ–æ</li>
                    <li>‚ôæÔ∏è –ü–æ–∂–∏–∑–Ω–µ–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø</li>
                    <li>üì± –î–æ—Å—Ç—É–ø —Å –º–æ–±–∏–ª—å–Ω—ã—Ö</li>
                    <li>üèÜ –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç</li>
                </ul>
            </div>
        </aside>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/main.js' %}"></script>
<script src="{% static 'js/courses.js' %}"></script>
{% endblock %}

{% extends 'base.html' %}
{% load static %}

{% block title %}{{ course.title }} - Конструктор курса - CourseMaster{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/course-builder.css' %}">
{% endblock %}

{% block content %}
<div class="course-builder">
    <!-- Верхняя панель -->
    <div class="builder-header">
        <div class="d-flex align-items-center gap-3">
            <a href="{% url 'instructor_courses' %}" class="btn btn-link text-white p-0" title="Назад к курсам">
                <i class="bi bi-arrow-left fs-4"></i>
            </a>
            <div class="course-title-edit">
                <input type="text" 
                       id="courseTitle" 
                       class="course-title-input" 
                       value="{{ course.title }}"
                       placeholder="Название курса">
            </div>
            <span id="saveIndicator" class="save-indicator">
                <i class="bi bi-check-circle"></i> Сохранено
            </span>
        </div>
        <div class="header-actions">
            <div class="btn-group">
                <button type="button" class="btn btn-outline-light btn-sm dropdown-toggle" data-bs-toggle="dropdown">
                    <i class="bi bi-gear"></i> Настройки
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#courseSettingsModal">
                        <i class="bi bi-sliders"></i> Основные настройки
                    </a></li>
                    <li><a class="dropdown-item" href="{% url 'media_library' course.slug %}">
                        <i class="bi bi-images"></i> Медиа-библиотека
                    </a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item text-danger" href="{% url 'course_delete' course.slug %}">
                        <i class="bi bi-trash"></i> Удалить курс
                    </a></li>
                </ul>
            </div>
            
            <a href="{% url 'course_detail' course.slug %}" class="btn btn-outline-light btn-sm" target="_blank">
                <i class="bi bi-eye"></i> Предпросмотр
            </a>
            
            {% if course.status == 'draft' %}
            <button type="button" class="btn btn-success btn-sm" id="publishBtn">
                <i class="bi bi-upload"></i> Опубликовать
            </button>
            {% else %}
            <button type="button" class="btn btn-warning btn-sm" id="unpublishBtn">
                <i class="bi bi-pause-circle"></i> Снять с публикации
            </button>
            {% endif %}
        </div>
    </div>

    <div class="builder-container">
        <!-- Боковая панель -->
        <aside class="builder-sidebar">
            <!-- Статистика -->
            <div class="sidebar-section">
                <h6 class="sidebar-title">
                    <i class="bi bi-bar-chart"></i> Статистика
                </h6>
                <div class="stats-grid">
                    <div class="stat-item">
                        <span class="stat-value" id="statSections">{{ sections|length }}</span>
                        <span class="stat-label">Модулей</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="statLessons">{{ total_lessons }}</span>
                        <span class="stat-label">Уроков</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value">{{ total_enrollments }}</span>
                        <span class="stat-label">Студентов</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value">{{ course.average_rating|floatformat:1 }}</span>
                        <span class="stat-label">Рейтинг</span>
                    </div>
                </div>
            </div>

            <!-- Статус -->
            <div class="sidebar-section">
                <h6 class="sidebar-title">
                    <i class="bi bi-info-circle"></i> Статус
                </h6>
                <div class="status-badge {% if course.status == 'published' %}status-published{% else %}status-draft{% endif %}">
                    {% if course.status == 'published' %}
                    <i class="bi bi-check-circle"></i> Опубликован
                    {% else %}
                    <i class="bi bi-pencil"></i> Черновик
                    {% endif %}
                </div>
            </div>

            <!-- Навигация по модулям -->
            <div class="sidebar-section">
                <h6 class="sidebar-title">
                    <i class="bi bi-list-nested"></i> Структура
                </h6>
                <nav class="section-nav" id="sectionNav">
                    {% for section in sections %}
                    <a href="#section-{{ section.id }}" class="section-nav-item">
                        <span class="nav-number">{{ forloop.counter }}</span>
                        <span class="nav-title">{{ section.title }}</span>
                        <span class="nav-badge">{{ section.lessons.count }}</span>
                    </a>
                    {% empty %}
                    <p class="text-muted small px-3">Нет модулей</p>
                    {% endfor %}
                </nav>
            </div>
        </aside>

        <!-- Основной контент -->
        <main class="builder-main">
            <!-- Контейнер модулей -->
            <div class="sections-container" id="sectionsContainer">
                {% for section in sections %}
                <div class="section-card" id="section-{{ section.id }}" data-section-id="{{ section.id }}">
                    <!-- Заголовок модуля -->
                    <div class="section-header">
                        <div class="section-drag-handle">
                            <i class="bi bi-grip-vertical"></i>
                        </div>
                        <div class="section-number">{{ forloop.counter }}</div>
                        <input type="text" 
                               class="section-title-input" 
                               value="{{ section.title }}"
                               placeholder="Название модуля"
                               onchange="updateSection({{ section.id }}, 'title', this.value)">
                        <div class="section-actions">
                            <button type="button" class="btn btn-sm btn-link" onclick="toggleSectionCollapse({{ section.id }})">
                                <i class="bi bi-chevron-up"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-link text-danger" onclick="deleteSection({{ section.id }})">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Контент модуля (уроки) -->
                    <div class="section-content" id="sectionContent-{{ section.id }}">
                        <!-- Список уроков -->
                        <div class="lessons-list" id="lessonsList-{{ section.id }}">
                            {% for lesson in section.lessons.all %}
                            <div class="lesson-card" id="lesson-{{ lesson.id }}" data-lesson-id="{{ lesson.id }}">
                                <div class="lesson-drag-handle">
                                    <i class="bi bi-grip-vertical"></i>
                                </div>
                                <div class="lesson-icon icon-lesson">
                                    <i class="bi bi-journal-text"></i>
                                </div>
                                <div class="lesson-info">
                                    <input type="text" 
                                           class="lesson-title-input" 
                                           value="{{ lesson.title }}"
                                           placeholder="Название урока"
                                           onchange="updateLesson({{ lesson.id }}, 'title', this.value)">
                                    <div class="lesson-meta">
                                        <span class="lesson-steps-count">
                                            <i class="bi bi-layers"></i> {{ lesson.steps.count }} шагов
                                        </span>
                                        {% if lesson.duration_minutes > 0 %}
                                        <span class="lesson-duration">{{ lesson.duration_minutes }} мин</span>
                                        {% endif %}
                                        {% if lesson.is_preview %}
                                        <span class="lesson-preview-badge">Превью</span>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="lesson-actions">
                                    <button type="button" class="btn btn-sm btn-link text-primary" onclick="openStepEditor({{ lesson.id }}, '{{ lesson.title|escapejs }}')" title="Редактор шагов">
                                        <i class="bi bi-list-ol"></i>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-link" onclick="editLesson({{ lesson.id }})" title="Настройки">
                                        <i class="bi bi-gear"></i>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-link text-danger" onclick="deleteLesson({{ lesson.id }})" title="Удалить">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                            {% endfor %}
                        </div>

                        <!-- Кнопка добавления урока (одна, без типов) -->
                        <div class="add-lesson-section">
                            <button type="button" class="add-lesson-btn" onclick="addLesson({{ section.id }})">
                                <i class="bi bi-plus-lg"></i>
                                <span>Добавить урок</span>
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Кнопка добавления модуля -->
            <div class="add-section-container">
                <button type="button" class="add-section-btn" onclick="addSection()">
                    <i class="bi bi-plus-lg"></i>
                    <span>Добавить модуль</span>
                </button>
            </div>

        </main>
    </div>
</div>

<!-- Модальное окно редактирования урока -->
<div class="modal fade" id="lessonEditModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-pencil"></i> Редактирование урока
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="lessonEditForm">
                    <input type="hidden" id="editLessonId">
                    
                    <div class="mb-3">
                        <label class="form-label">Название урока</label>
                        <input type="text" class="form-control" id="editLessonTitle" required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Длительность (минуты)</label>
                        <input type="number" class="form-control" id="editLessonDuration" min="0">
                        <small class="text-muted">Примерное время прохождения урока</small>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input type="checkbox" class="form-check-input" id="editLessonPreview">
                        <label class="form-check-label" for="editLessonPreview">
                            Бесплатный просмотр (доступен без покупки курса)
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" onclick="saveLessonEdit()">
                    <i class="bi bi-check-lg"></i> Сохранить
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно настроек курса -->
<div class="modal fade" id="courseSettingsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-sliders"></i> Настройки курса
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="courseSettingsForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Название курса</label>
                            <input type="text" class="form-control" id="settingsTitle" value="{{ course.title }}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Категория</label>
                            <select class="form-select" id="settingsCategory">
                                {% for cat in categories %}
                                <option value="{{ cat.id }}" {% if cat.id == course.category_id %}selected{% endif %}>{{ cat.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Подзаголовок</label>
                        <input type="text" class="form-control" id="settingsSubtitle" value="{{ course.subtitle }}">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Описание</label>
                        <textarea class="form-control" id="settingsDescription" rows="4">{{ course.description }}</textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Уровень сложности</label>
                            <select class="form-select" id="settingsLevel">
                                <option value="beginner" {% if course.level == 'beginner' %}selected{% endif %}>Начинающий</option>
                                <option value="intermediate" {% if course.level == 'intermediate' %}selected{% endif %}>Средний</option>
                                <option value="advanced" {% if course.level == 'advanced' %}selected{% endif %}>Продвинутый</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Язык</label>
                            <input type="text" class="form-control" id="settingsLanguage" value="{{ course.language }}">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Длительность (часы)</label>
                            <input type="number" class="form-control" id="settingsDuration" value="{{ course.duration_hours }}" step="0.5" min="0">
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Цена (₽)</label>
                            <input type="number" class="form-control" id="settingsPrice" value="{{ course.price }}" min="0" step="0.01">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Цена со скидкой (₽)</label>
                            <input type="number" class="form-control" id="settingsDiscountPrice" value="{{ course.discount_price|default:'' }}" min="0" step="0.01">
                        </div>
                        <div class="col-md-4 mb-3 d-flex align-items-end">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="settingsIsFree" {% if course.is_free %}checked{% endif %}>
                                <label class="form-check-label" for="settingsIsFree">Бесплатный курс</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">URL превью видео</label>
                        <input type="url" class="form-control" id="settingsPreviewVideo" value="{{ course.preview_video }}">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Чему научатся студенты (каждый пункт с новой строки)</label>
                        <textarea class="form-control" id="settingsLearningOutcomes" rows="3">{{ course.learning_outcomes }}</textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Требования (каждый пункт с новой строки)</label>
                        <textarea class="form-control" id="settingsRequirements" rows="3">{{ course.requirements }}</textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Целевая аудитория (каждый пункт с новой строки)</label>
                        <textarea class="form-control" id="settingsTargetAudience" rows="3">{{ course.target_audience }}</textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" onclick="saveCourseSettings()">
                    <i class="bi bi-check-lg"></i> Сохранить
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно редактирования задания -->
<div class="modal fade" id="assignmentEditModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-clipboard-check"></i> Настройки задания
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="assignmentEditForm">
                    <input type="hidden" id="editAssignmentId">
                    
                    <div class="mb-3">
                        <label class="form-label">Название задания</label>
                        <input type="text" class="form-control" id="assignmentTitle" placeholder="Введите название">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Описание задания</label>
                        <textarea class="form-control" id="assignmentDescription" rows="5" placeholder="Опишите задание для студентов..."></textarea>
                        <small class="text-muted">Поддерживается Markdown</small>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Максимум баллов</label>
                                <input type="number" class="form-control" id="assignmentMaxPoints" min="1" max="1000" value="100">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Дедлайн (опционально)</label>
                                <input type="datetime-local" class="form-control" id="assignmentDueDate">
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        После сохранения студенты смогут отправлять работы, а вы — проверять и оценивать их.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <a href="#" id="viewSubmissionsLink" class="btn btn-outline-primary me-auto" target="_blank">
                    <i class="bi bi-eye"></i> Посмотреть работы
                </a>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" onclick="saveAssignment()">
                    <i class="bi bi-check-lg"></i> Сохранить
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно редактора шагов (Step Editor) -->
<div class="modal fade" id="stepEditorModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-fullscreen-lg-down">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="bi bi-list-ol"></i> Редактор шагов: <span id="stepEditorLessonTitle"></span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <div class="step-editor">
                    <!-- Левая панель - список шагов -->
                    <div class="step-sidebar">
                        <div class="step-sidebar-header">
                            <h6><i class="bi bi-layers"></i> Шаги урока</h6>
                        </div>
                        <div id="stepsList" class="steps-list">
                            <!-- Шаги загружаются динамически -->
                        </div>
                        
                        <!-- Меню добавления шага -->
                        <div class="add-step-menu">
                            <div class="dropdown">
                                <button class="btn btn-outline-primary btn-sm w-100 dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                    <i class="bi bi-plus-lg"></i> Добавить шаг
                                </button>
                                <ul class="dropdown-menu w-100">
                                    <li><h6 class="dropdown-header">Контент</h6></li>
                                    <li><a class="dropdown-item" href="#" onclick="addStep('text')"><i class="bi bi-file-text"></i> Текст/Теория</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="addStep('video')"><i class="bi bi-play-circle"></i> Видео</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><h6 class="dropdown-header">Тесты</h6></li>
                                    <li><a class="dropdown-item" href="#" onclick="addStep('quiz_single')"><i class="bi bi-ui-radios"></i> Один ответ</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="addStep('quiz_multiple')"><i class="bi bi-ui-checks"></i> Несколько ответов</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="addStep('quiz_sorting')"><i class="bi bi-sort-numeric-down"></i> Сортировка</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="addStep('quiz_matching')"><i class="bi bi-arrows"></i> Сопоставление</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="addStep('fill_blanks')"><i class="bi bi-input-cursor-text"></i> Пропуски</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><h6 class="dropdown-header">Ответы</h6></li>
                                    <li><a class="dropdown-item" href="#" onclick="addStep('numeric')"><i class="bi bi-123"></i> Числовой</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="addStep('text_answer')"><i class="bi bi-cursor-text"></i> Текстовый</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="addStep('free_answer')"><i class="bi bi-pencil-square"></i> Эссе</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><h6 class="dropdown-header">Программирование</h6></li>
                                    <li><a class="dropdown-item" href="#" onclick="addStep('code')"><i class="bi bi-code-slash"></i> Код</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="addStep('sql')"><i class="bi bi-database"></i> SQL</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Правая панель - редактор шага -->
                    <div class="step-content">
                        <div id="stepEditorPlaceholder" class="step-placeholder">
                            <i class="bi bi-arrow-left-circle"></i>
                            <p>Выберите шаг слева или добавьте новый</p>
                        </div>
                        <div id="stepEditorContent" class="step-editor-content" style="display: none;">
                            <!-- Редактор шага загружается динамически -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Константы
const COURSE_ID = {{ course.id }};
const COURSE_SLUG = '{{ course.slug }}';
const CSRF_TOKEN = '{{ csrf_token }}';

// Получить CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Показать индикатор сохранения
function showSaveIndicator(saving = false) {
    const indicator = document.getElementById('saveIndicator');
    if (saving) {
        indicator.innerHTML = '<i class="bi bi-arrow-repeat spin"></i> Сохранение...';
        indicator.classList.add('saving');
    } else {
        indicator.innerHTML = '<i class="bi bi-check-circle"></i> Сохранено';
        indicator.classList.remove('saving');
    }
}

// API запрос
async function apiRequest(url, method, data = null) {
    showSaveIndicator(true);
    try {
        const options = {
            method: method,
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            }
        };
        if (data) {
            options.body = JSON.stringify(data);
        }
        const response = await fetch(url, options);
        const result = await response.json();
        showSaveIndicator(false);
        return result;
    } catch (error) {
        console.error('API Error:', error);
        showSaveIndicator(false);
        throw error;
    }
}

// ============================================================
// МОДУЛИ
// ============================================================

// Добавить модуль
async function addSection() {
    const result = await apiRequest(`/courses/api/course/${COURSE_ID}/section/create/`, 'POST', {
        title: 'Новый модуль'
    });
    
    if (result.success) {
        location.reload();
    } else {
        alert('Ошибка: ' + (result.error || 'Не удалось создать модуль'));
    }
}

// Обновить модуль
let sectionSaveTimeout;
function updateSection(sectionId, field, value) {
    clearTimeout(sectionSaveTimeout);
    sectionSaveTimeout = setTimeout(async () => {
        const data = {};
        data[field] = value;
        await apiRequest(`/courses/api/section/${sectionId}/update/`, 'POST', data);
    }, 500);
}

// Удалить модуль
async function deleteSection(sectionId) {
    if (!confirm('Удалить модуль и все его уроки? Это действие необратимо.')) {
        return;
    }
    
    const result = await apiRequest(`/courses/api/section/${sectionId}/delete/`, 'POST');
    
    if (result.success) {
        document.getElementById(`section-${sectionId}`).remove();
        updateStats();
    } else {
        alert('Ошибка: ' + (result.error || 'Не удалось удалить модуль'));
    }
}

// Свернуть/развернуть модуль
function toggleSectionCollapse(sectionId) {
    const content = document.getElementById(`sectionContent-${sectionId}`);
    const btn = event.currentTarget;
    const icon = btn.querySelector('i');
    
    if (content.style.display === 'none') {
        content.style.display = 'block';
        icon.className = 'bi bi-chevron-up';
    } else {
        content.style.display = 'none';
        icon.className = 'bi bi-chevron-down';
    }
}

// ============================================================
// УРОКИ
// ============================================================

// Добавить урок
async function addLesson(sectionId, lessonType) {
    const titles = {
        'video': 'Новый видео-урок',
        'article': 'Новая статья',
        'quiz': 'Новый тест',
        'assignment': 'Новое задание'
    };
    
    const result = await apiRequest(`/courses/api/section/${sectionId}/lesson/create/`, 'POST', {
        title: titles[lessonType],
        lesson_type: lessonType
    });
    
    if (result.success) {
        location.reload();
    } else {
        alert('Ошибка: ' + (result.error || 'Не удалось создать урок'));
    }
}

// Обновить урок (inline)
let lessonSaveTimeout;
function updateLesson(lessonId, field, value) {
    clearTimeout(lessonSaveTimeout);
    lessonSaveTimeout = setTimeout(async () => {
        const data = {};
        data[field] = value;
        await apiRequest(`/courses/api/lesson/${lessonId}/update/`, 'POST', data);
    }, 500);
}

// Открыть модальное окно редактирования урока
async function editLesson(lessonId) {
    // Загрузить данные урока
    const result = await apiRequest(`/courses/api/lesson/${lessonId}/`, 'GET');
    
    if (result.success) {
        const lesson = result.lesson;
        
        document.getElementById('editLessonId').value = lesson.id;
        document.getElementById('editLessonTitle').value = lesson.title;
        document.getElementById('editLessonDuration').value = lesson.duration_minutes || 0;
        document.getElementById('editLessonPreview').checked = lesson.is_preview;
        
        // Открыть модальное окно
        const modal = new bootstrap.Modal(document.getElementById('lessonEditModal'));
        modal.show();
    } else {
        alert('Ошибка: ' + (result.error || 'Не удалось загрузить урок'));
    }
}

// Сохранить редактирование урока
async function saveLessonEdit() {
    const lessonId = document.getElementById('editLessonId').value;
    const data = {
        title: document.getElementById('editLessonTitle').value,
        duration_minutes: parseInt(document.getElementById('editLessonDuration').value) || 0,
        is_preview: document.getElementById('editLessonPreview').checked
    };
    
    const result = await apiRequest(`/courses/api/lesson/${lessonId}/update/`, 'POST', data);
    
    if (result.success) {
        // Закрыть модальное окно и обновить страницу
        bootstrap.Modal.getInstance(document.getElementById('lessonEditModal')).hide();
        location.reload();
    } else {
        alert('Ошибка: ' + (result.error || 'Не удалось сохранить урок'));
    }
}

// Удалить урок
async function deleteLesson(lessonId) {
    if (!confirm('Удалить этот урок? Это действие необратимо.')) {
        return;
    }
    
    const result = await apiRequest(`/courses/api/lesson/${lessonId}/delete/`, 'POST');
    
    if (result.success) {
        document.getElementById(`lesson-${lessonId}`).remove();
        updateStats();
    } else {
        alert('Ошибка: ' + (result.error || 'Не удалось удалить урок'));
    }
}

// ============================================================
// ТЕСТЫ И ЗАДАНИЯ
// ============================================================

// Создать тест для урока
async function createQuiz(lessonId) {
    const result = await apiRequest(`/courses/api/lesson/${lessonId}/quiz/create/`, 'POST', {
        title: 'Тест',
        pass_percentage: 50
    });
    
    if (result.success) {
        // Перенаправить на редактор теста
        window.location.href = `/courses/instructor/quiz/${result.quiz_id}/builder/`;
    } else {
        alert('Ошибка: ' + (result.error || 'Не удалось создать тест'));
    }
}

// Создать задание для урока
async function createAssignment(lessonId) {
    const result = await apiRequest(`/courses/api/lesson/${lessonId}/assignment/create/`, 'POST', {
        title: 'Задание',
        max_points: 100
    });
    
    if (result.success) {
        // Открыть модальное окно для настройки задания
        await editAssignment(result.assignment_id);
        // Перезагрузить страницу для отображения кнопки
        location.reload();
    } else {
        alert('Ошибка: ' + (result.error || 'Не удалось создать задание'));
    }
}

// Редактировать задание
async function editAssignment(assignmentId) {
    // Загрузить данные задания
    const result = await apiRequest(`/courses/api/assignment/${assignmentId}/`, 'GET');
    
    if (result.success) {
        const assignment = result.assignment;
        
        // Заполнить форму
        document.getElementById('editAssignmentId').value = assignment.id;
        document.getElementById('assignmentTitle').value = assignment.title || '';
        document.getElementById('assignmentDescription').value = assignment.description || '';
        document.getElementById('assignmentMaxPoints').value = assignment.max_points || 100;
        
        if (assignment.due_date) {
            // Преобразовать ISO дату в формат datetime-local
            const date = new Date(assignment.due_date);
            const localDate = new Date(date.getTime() - date.getTimezoneOffset() * 60000);
            document.getElementById('assignmentDueDate').value = localDate.toISOString().slice(0, 16);
        } else {
            document.getElementById('assignmentDueDate').value = '';
        }
        
        // Обновить ссылку на просмотр работ
        document.getElementById('viewSubmissionsLink').href = `/courses/instructor/assignment/${assignment.id}/`;
        
        // Открыть модальное окно
        const modal = new bootstrap.Modal(document.getElementById('assignmentEditModal'));
        modal.show();
    } else {
        alert('Ошибка: ' + (result.error || 'Не удалось загрузить задание'));
    }
}

// Сохранить изменения задания
async function saveAssignment() {
    const assignmentId = document.getElementById('editAssignmentId').value;
    const data = {
        title: document.getElementById('assignmentTitle').value,
        description: document.getElementById('assignmentDescription').value,
        max_points: parseInt(document.getElementById('assignmentMaxPoints').value),
        due_date: document.getElementById('assignmentDueDate').value || null
    };
    
    const result = await apiRequest(`/courses/api/assignment/${assignmentId}/update/`, 'POST', data);
    
    if (result.success) {
        // Закрыть модальное окно
        const modal = bootstrap.Modal.getInstance(document.getElementById('assignmentEditModal'));
        modal.hide();
        
        // Показать уведомление
        alert('Задание сохранено!');
    } else {
        alert('Ошибка: ' + (result.error || 'Не удалось сохранить задание'));
    }
}

// ============================================================
// НАСТРОЙКИ КУРСА
// ============================================================

// Сохранить настройки курса
async function saveCourseSettings() {
    const data = {
        title: document.getElementById('settingsTitle').value,
        subtitle: document.getElementById('settingsSubtitle').value,
        description: document.getElementById('settingsDescription').value,
        category_id: parseInt(document.getElementById('settingsCategory').value),
        level: document.getElementById('settingsLevel').value,
        language: document.getElementById('settingsLanguage').value,
        duration_hours: parseFloat(document.getElementById('settingsDuration').value) || 0,
        price: parseFloat(document.getElementById('settingsPrice').value) || 0,
        discount_price: parseFloat(document.getElementById('settingsDiscountPrice').value) || null,
        is_free: document.getElementById('settingsIsFree').checked,
        preview_video: document.getElementById('settingsPreviewVideo').value,
        learning_outcomes: document.getElementById('settingsLearningOutcomes').value,
        requirements: document.getElementById('settingsRequirements').value,
        target_audience: document.getElementById('settingsTargetAudience').value
    };
    
    const result = await apiRequest(`/courses/api/course/${COURSE_ID}/update/`, 'POST', data);
    
    if (result.success) {
        bootstrap.Modal.getInstance(document.getElementById('courseSettingsModal')).hide();
        // Обновить заголовок
        document.getElementById('courseTitle').value = data.title;
        alert('Настройки сохранены!');
    } else {
        alert('Ошибка: ' + (result.error || 'Не удалось сохранить настройки'));
    }
}

// Обновить название курса (inline)
let courseTitleTimeout;
document.getElementById('courseTitle').addEventListener('input', function() {
    clearTimeout(courseTitleTimeout);
    courseTitleTimeout = setTimeout(async () => {
        await apiRequest(`/courses/api/course/${COURSE_ID}/update/`, 'POST', {
            title: this.value
        });
    }, 500);
});

// ============================================================
// ПУБЛИКАЦИЯ
// ============================================================

// Опубликовать курс
document.getElementById('publishBtn')?.addEventListener('click', async function() {
    if (!confirm('Опубликовать курс? Он станет доступен студентам.')) {
        return;
    }
    
    const result = await apiRequest(`/courses/api/course/${COURSE_ID}/publish/`, 'POST');
    
    if (result.success) {
        location.reload();
    } else {
        alert('Ошибка: ' + (result.error || 'Не удалось опубликовать курс'));
    }
});

// Снять с публикации
document.getElementById('unpublishBtn')?.addEventListener('click', async function() {
    if (!confirm('Снять курс с публикации? Он перестанет быть доступен студентам.')) {
        return;
    }
    
    const result = await apiRequest(`/courses/api/course/${COURSE_ID}/unpublish/`, 'POST');
    
    if (result.success) {
        location.reload();
    } else {
        alert('Ошибка: ' + (result.error || 'Не удалось снять курс с публикации'));
    }
});

// ============================================================
// УТИЛИТЫ
// ============================================================

// Обновить статистику
function updateStats() {
    const sections = document.querySelectorAll('.section-card').length;
    const lessons = document.querySelectorAll('.lesson-card').length;
    
    document.getElementById('statSections').textContent = sections;
    document.getElementById('statLessons').textContent = lessons;
    
    // Скрыть/показать пустое состояние
    const emptyState = document.getElementById('emptyState');
    if (emptyState) {
        emptyState.style.display = sections === 0 ? 'flex' : 'none';
    }
}

// Инициализация
document.addEventListener('DOMContentLoaded', function() {
    // Добавить smooth scroll к навигации
    document.querySelectorAll('.section-nav-item').forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            const target = document.querySelector(this.getAttribute('href'));
            if (target) {
                target.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        });
    });
});

// ============================================================
// РЕДАКТОР ШАГОВ (STEP EDITOR)
// ============================================================

let currentLessonId = null;
let currentStepId = null;
let stepsData = [];

// Открыть редактор шагов для урока
async function openStepEditor(lessonId, lessonTitle) {
    currentLessonId = lessonId;
    currentStepId = null;
    
    document.getElementById('stepEditorLessonTitle').textContent = lessonTitle;
    
    // Загрузить шаги
    await loadSteps();
    
    // Показать плейсхолдер
    document.getElementById('stepEditorPlaceholder').style.display = 'flex';
    document.getElementById('stepEditorContent').style.display = 'none';
    
    // Открыть модальное окно
    const modal = new bootstrap.Modal(document.getElementById('stepEditorModal'));
    modal.show();
}

// Загрузить список шагов
async function loadSteps() {
    const result = await apiRequest(`/courses/api/lesson/${currentLessonId}/steps/`, 'GET');
    
    if (result.success) {
        stepsData = result.steps;
        renderStepsList();
    }
}

// Отрисовать список шагов
function renderStepsList() {
    const container = document.getElementById('stepsList');
    
    if (stepsData.length === 0) {
        container.innerHTML = `
            <div class="empty-steps">
                <i class="bi bi-inbox"></i>
                <p>Нет шагов</p>
                <small>Добавьте первый шаг</small>
            </div>
        `;
        return;
    }
    
    container.innerHTML = stepsData.map((step, index) => `
        <div class="step-item ${currentStepId === step.id ? 'active' : ''}" 
             onclick="selectStep(${step.id})" 
             data-step-id="${step.id}">
            <div class="step-item-order">${index + 1}</div>
            <div class="step-item-info">
                <div class="step-item-type">${getStepTypeIcon(step.step_type)} ${step.step_type_display}</div>
                <div class="step-item-title">${step.title || 'Без названия'}</div>
            </div>
            <div class="step-item-actions">
                <button class="btn btn-sm btn-link" onclick="event.stopPropagation(); duplicateStep(${step.id})" title="Дублировать">
                    <i class="bi bi-copy"></i>
                </button>
                <button class="btn btn-sm btn-link text-danger" onclick="event.stopPropagation(); deleteStep(${step.id})" title="Удалить">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        </div>
    `).join('');
}

// Иконка типа шага
function getStepTypeIcon(stepType) {
    const icons = {
        'text': '<i class="bi bi-file-text"></i>',
        'video': '<i class="bi bi-play-circle"></i>',
        'quiz_single': '<i class="bi bi-ui-radios"></i>',
        'quiz_multiple': '<i class="bi bi-ui-checks"></i>',
        'quiz_sorting': '<i class="bi bi-sort-numeric-down"></i>',
        'quiz_matching': '<i class="bi bi-arrows"></i>',
        'fill_blanks': '<i class="bi bi-input-cursor-text"></i>',
        'numeric': '<i class="bi bi-123"></i>',
        'text_answer': '<i class="bi bi-cursor-text"></i>',
        'free_answer': '<i class="bi bi-pencil-square"></i>',
        'code': '<i class="bi bi-code-slash"></i>',
        'sql': '<i class="bi bi-database"></i>'
    };
    return icons[stepType] || '<i class="bi bi-circle"></i>';
}

// Добавить шаг
async function addStep(stepType) {
    const result = await apiRequest(`/courses/api/lesson/${currentLessonId}/step/create/`, 'POST', {
        step_type: stepType,
        title: ''
    });
    
    if (result.success) {
        stepsData.push(result.step);
        renderStepsList();
        selectStep(result.step.id);
    } else {
        alert('Ошибка: ' + (result.error || 'Не удалось создать шаг'));
    }
}

// Выбрать шаг для редактирования
async function selectStep(stepId) {
    currentStepId = stepId;
    
    // Обновить активный элемент в списке
    document.querySelectorAll('.step-item').forEach(item => {
        item.classList.toggle('active', parseInt(item.dataset.stepId) === stepId);
    });
    
    // Загрузить данные шага
    const result = await apiRequest(`/courses/api/step/${stepId}/`, 'GET');
    
    if (result.success) {
        renderStepEditor(result.step);
    }
}

// Отрисовать редактор шага
function renderStepEditor(step) {
    document.getElementById('stepEditorPlaceholder').style.display = 'none';
    document.getElementById('stepEditorContent').style.display = 'block';
    
    const container = document.getElementById('stepEditorContent');
    
    let editorHtml = `
        <div class="step-editor-header">
            <div class="step-type-badge">${getStepTypeIcon(step.step_type)} ${step.step_type_display}</div>
            <div class="step-settings">
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="stepRequired" 
                           ${step.is_required ? 'checked' : ''} onchange="updateStepField('is_required', this.checked)">
                    <label class="form-check-label" for="stepRequired">Обязательный</label>
                </div>
                <div class="points-input">
                    <label>Баллы:</label>
                    <input type="number" class="form-control form-control-sm" id="stepPoints" 
                           value="${step.points}" min="0" onchange="updateStepField('points', parseInt(this.value))">
                </div>
            </div>
        </div>
        
        <div class="step-editor-body">
            <div class="mb-3">
                <label class="form-label">Название шага (опционально)</label>
                <input type="text" class="form-control" id="stepTitle" value="${step.title || ''}" 
                       placeholder="Введите название..." onchange="updateStepField('title', this.value)">
            </div>
            
            ${getStepContentEditor(step)}
        </div>
    `;
    
    container.innerHTML = editorHtml;
}

// Получить редактор контента для типа шага
function getStepContentEditor(step) {
    const content = step.content || {};
    
    switch (step.step_type) {
        case 'text':
            return `
                <div class="mb-3">
                    <label class="form-label">Содержание (Markdown)</label>
                    <textarea class="form-control" id="stepContentMarkdown" rows="15" 
                              placeholder="# Заголовок\n\nТекст урока..."
                              onchange="updateStepContent('markdown', this.value)">${content.markdown || ''}</textarea>
                    <small class="text-muted">Поддерживается Markdown синтаксис</small>
                </div>
            `;
        
        case 'video':
            return `
                <div class="mb-3">
                    <label class="form-label">URL видео</label>
                    <input type="url" class="form-control" id="stepContentVideoUrl" 
                           value="${content.url || ''}" placeholder="https://youtube.com/watch?v=..."
                           onchange="updateStepContent('url', this.value)">
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Источник</label>
                        <select class="form-select" id="stepContentVideoSource" onchange="updateStepContent('source', this.value)">
                            <option value="youtube" ${content.source === 'youtube' ? 'selected' : ''}>YouTube</option>
                            <option value="vimeo" ${content.source === 'vimeo' ? 'selected' : ''}>Vimeo</option>
                            <option value="rutube" ${content.source === 'rutube' ? 'selected' : ''}>Rutube</option>
                            <option value="other" ${content.source === 'other' ? 'selected' : ''}>Другое</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Длительность (сек)</label>
                        <input type="number" class="form-control" id="stepContentDuration" 
                               value="${content.duration || 0}" min="0"
                               onchange="updateStepContent('duration', parseInt(this.value))">
                    </div>
                </div>
            `;
        
        case 'quiz_single':
        case 'quiz_multiple':
            const isMultiple = step.step_type === 'quiz_multiple';
            const choices = content.choices || ['Вариант 1', 'Вариант 2'];
            const correctIndex = content.correct_index ?? 0;
            const correctIndexes = content.correct_indexes || [0];
            
            return `
                <div class="mb-3">
                    <label class="form-label">Вопрос</label>
                    <textarea class="form-control" id="stepContentQuestion" rows="3"
                              placeholder="Введите вопрос..."
                              onchange="updateStepContent('question', this.value)">${content.question || ''}</textarea>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Варианты ответов</label>
                    <div id="choicesContainer">
                        ${choices.map((choice, i) => `
                            <div class="choice-item d-flex gap-2 mb-2">
                                <input type="${isMultiple ? 'checkbox' : 'radio'}" class="form-check-input mt-2"
                                       name="correctChoice" value="${i}"
                                       ${isMultiple ? (correctIndexes.includes(i) ? 'checked' : '') : (correctIndex === i ? 'checked' : '')}
                                       onchange="updateCorrectAnswer(${i}, this.checked)">
                                <input type="text" class="form-control" value="${choice}"
                                       placeholder="Вариант ${i + 1}"
                                       onchange="updateChoice(${i}, this.value)">
                                <button class="btn btn-outline-danger btn-sm" onclick="removeChoice(${i})" ${choices.length <= 2 ? 'disabled' : ''}>
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        `).join('')}
                    </div>
                    <button class="btn btn-outline-primary btn-sm" onclick="addChoice()">
                        <i class="bi bi-plus"></i> Добавить вариант
                    </button>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Пояснение (показывается после ответа)</label>
                    <textarea class="form-control" id="stepContentExplanation" rows="2"
                              placeholder="Пояснение к правильному ответу..."
                              onchange="updateStepContent('explanation', this.value)">${content.explanation || ''}</textarea>
                </div>
            `;
        
        case 'numeric':
            return `
                <div class="mb-3">
                    <label class="form-label">Вопрос</label>
                    <textarea class="form-control" id="stepContentQuestion" rows="3"
                              placeholder="Введите вопрос..."
                              onchange="updateStepContent('question', this.value)">${content.question || ''}</textarea>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Правильный ответ</label>
                        <input type="number" class="form-control" id="stepContentAnswer" 
                               value="${content.answer ?? 0}" step="any"
                               onchange="updateStepContent('answer', parseFloat(this.value))">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Допустимая погрешность</label>
                        <input type="number" class="form-control" id="stepContentTolerance" 
                               value="${content.tolerance ?? 0}" step="any" min="0"
                               onchange="updateStepContent('tolerance', parseFloat(this.value))">
                    </div>
                </div>
            `;
        
        case 'text_answer':
            return `
                <div class="mb-3">
                    <label class="form-label">Вопрос</label>
                    <textarea class="form-control" id="stepContentQuestion" rows="3"
                              placeholder="Введите вопрос..."
                              onchange="updateStepContent('question', this.value)">${content.question || ''}</textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label">Правильные ответы (каждый с новой строки)</label>
                    <textarea class="form-control" id="stepContentPatterns" rows="3"
                              placeholder="Правильный ответ 1\nПравильный ответ 2"
                              onchange="updateStepContent('patterns', this.value.split('\\n').filter(p => p.trim()))">${(content.patterns || []).join('\n')}</textarea>
                    <small class="text-muted">Можно использовать регулярные выражения</small>
                </div>
                <div class="form-check mb-3">
                    <input type="checkbox" class="form-check-input" id="stepContentCaseSensitive"
                           ${content.case_sensitive ? 'checked' : ''}
                           onchange="updateStepContent('case_sensitive', this.checked)">
                    <label class="form-check-label" for="stepContentCaseSensitive">Учитывать регистр</label>
                </div>
            `;
        
        case 'free_answer':
            return `
                <div class="mb-3">
                    <label class="form-label">Задание</label>
                    <textarea class="form-control" id="stepContentQuestion" rows="4"
                              placeholder="Опишите задание для эссе..."
                              onchange="updateStepContent('question', this.value)">${content.question || ''}</textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label">Минимальная длина ответа (символов)</label>
                    <input type="number" class="form-control" id="stepContentMinLength" 
                           value="${content.min_length || 100}" min="0"
                           onchange="updateStepContent('min_length', parseInt(this.value))">
                </div>
                <div class="mb-3">
                    <label class="form-label">Критерии оценки (для преподавателя)</label>
                    <textarea class="form-control" id="stepContentRubric" rows="3"
                              placeholder="Критерии оценивания..."
                              onchange="updateStepContent('rubric', this.value)">${content.rubric || ''}</textarea>
                </div>
            `;
        
        case 'code':
            return `
                <div class="mb-3">
                    <label class="form-label">Описание задачи</label>
                    <textarea class="form-control" id="stepContentDescription" rows="4"
                              placeholder="Опишите задачу для программирования..."
                              onchange="updateStepContent('description', this.value)">${content.description || ''}</textarea>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Язык программирования</label>
                        <select class="form-select" id="stepContentLanguage" onchange="updateStepContent('language', this.value)">
                            <option value="python" ${content.language === 'python' ? 'selected' : ''}>Python</option>
                            <option value="javascript" ${content.language === 'javascript' ? 'selected' : ''}>JavaScript</option>
                            <option value="java" ${content.language === 'java' ? 'selected' : ''}>Java</option>
                            <option value="cpp" ${content.language === 'cpp' ? 'selected' : ''}>C++</option>
                            <option value="csharp" ${content.language === 'csharp' ? 'selected' : ''}>C#</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Лимит времени (сек)</label>
                        <input type="number" class="form-control" id="stepContentTimeLimit" 
                               value="${content.time_limit || 5}" min="1"
                               onchange="updateStepContent('time_limit', parseInt(this.value))">
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Шаблон кода</label>
                    <textarea class="form-control font-monospace" id="stepContentTemplate" rows="6"
                              placeholder="# Ваш код здесь"
                              onchange="updateStepContent('template', this.value)">${content.template || ''}</textarea>
                </div>
            `;
        
        case 'sql':
            return `
                <div class="mb-3">
                    <label class="form-label">Описание задачи</label>
                    <textarea class="form-control" id="stepContentDescription" rows="3"
                              placeholder="Опишите SQL-задачу..."
                              onchange="updateStepContent('description', this.value)">${content.description || ''}</textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label">Схема базы данных</label>
                    <textarea class="form-control font-monospace" id="stepContentSchema" rows="5"
                              placeholder="CREATE TABLE ..."
                              onchange="updateStepContent('database_schema', this.value)">${content.database_schema || ''}</textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label">Ожидаемый запрос</label>
                    <textarea class="form-control font-monospace" id="stepContentQuery" rows="3"
                              placeholder="SELECT ..."
                              onchange="updateStepContent('expected_query', this.value)">${content.expected_query || ''}</textarea>
                </div>
            `;
        
        default:
            return `
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    Редактор для этого типа шага ещё в разработке.
                </div>
                <div class="mb-3">
                    <label class="form-label">JSON контент</label>
                    <textarea class="form-control font-monospace" rows="10"
                              onchange="try { updateStepField('content', JSON.parse(this.value)); } catch(e) { }">${JSON.stringify(content, null, 2)}</textarea>
                </div>
            `;
    }
}

// Обновить поле шага
let stepUpdateTimeout;
async function updateStepField(field, value) {
    if (!currentStepId) return;
    
    clearTimeout(stepUpdateTimeout);
    stepUpdateTimeout = setTimeout(async () => {
        const data = {};
        data[field] = value;
        await apiRequest(`/courses/api/step/${currentStepId}/update/`, 'POST', data);
        
        // Обновить данные в памяти
        const step = stepsData.find(s => s.id === currentStepId);
        if (step) {
            step[field] = value;
            if (field === 'title') {
                renderStepsList();
            }
        }
    }, 500);
}

// Обновить контент шага
async function updateStepContent(field, value) {
    if (!currentStepId) return;
    
    const step = stepsData.find(s => s.id === currentStepId);
    if (!step) return;
    
    // Обновить в памяти
    if (!step.content) step.content = {};
    step.content[field] = value;
    
    // Сохранить на сервер
    clearTimeout(stepUpdateTimeout);
    stepUpdateTimeout = setTimeout(async () => {
        await apiRequest(`/courses/api/step/${currentStepId}/update/`, 'POST', {
            content: step.content
        });
    }, 500);
}

// Функции для работы с вариантами ответов (quiz)
function updateChoice(index, value) {
    const step = stepsData.find(s => s.id === currentStepId);
    if (!step || !step.content.choices) return;
    
    step.content.choices[index] = value;
    updateStepContent('choices', step.content.choices);
}

function addChoice() {
    const step = stepsData.find(s => s.id === currentStepId);
    if (!step) return;
    
    if (!step.content.choices) step.content.choices = [];
    step.content.choices.push(`Вариант ${step.content.choices.length + 1}`);
    
    updateStepContent('choices', step.content.choices);
    selectStep(currentStepId); // Перерисовать
}

function removeChoice(index) {
    const step = stepsData.find(s => s.id === currentStepId);
    if (!step || !step.content.choices || step.content.choices.length <= 2) return;
    
    step.content.choices.splice(index, 1);
    
    // Корректировать correct_index/correct_indexes
    if (step.step_type === 'quiz_single') {
        if (step.content.correct_index === index) {
            step.content.correct_index = 0;
        } else if (step.content.correct_index > index) {
            step.content.correct_index--;
        }
        updateStepContent('correct_index', step.content.correct_index);
    } else {
        step.content.correct_indexes = (step.content.correct_indexes || [])
            .filter(i => i !== index)
            .map(i => i > index ? i - 1 : i);
        updateStepContent('correct_indexes', step.content.correct_indexes);
    }
    
    updateStepContent('choices', step.content.choices);
    selectStep(currentStepId); // Перерисовать
}

function updateCorrectAnswer(index, checked) {
    const step = stepsData.find(s => s.id === currentStepId);
    if (!step) return;
    
    if (step.step_type === 'quiz_single') {
        step.content.correct_index = index;
        updateStepContent('correct_index', index);
    } else {
        if (!step.content.correct_indexes) step.content.correct_indexes = [];
        if (checked) {
            if (!step.content.correct_indexes.includes(index)) {
                step.content.correct_indexes.push(index);
            }
        } else {
            step.content.correct_indexes = step.content.correct_indexes.filter(i => i !== index);
        }
        updateStepContent('correct_indexes', step.content.correct_indexes);
    }
}

// Удалить шаг
async function deleteStep(stepId) {
    if (!confirm('Удалить этот шаг?')) return;
    
    const result = await apiRequest(`/courses/api/step/${stepId}/delete/`, 'POST');
    
    if (result.success) {
        stepsData = stepsData.filter(s => s.id !== stepId);
        renderStepsList();
        
        if (currentStepId === stepId) {
            currentStepId = null;
            document.getElementById('stepEditorPlaceholder').style.display = 'flex';
            document.getElementById('stepEditorContent').style.display = 'none';
        }
    } else {
        alert('Ошибка: ' + (result.error || 'Не удалось удалить шаг'));
    }
}

// Дублировать шаг
async function duplicateStep(stepId) {
    const result = await apiRequest(`/courses/api/step/${stepId}/duplicate/`, 'POST');
    
    if (result.success) {
        stepsData.push(result.step);
        renderStepsList();
        selectStep(result.step.id);
    } else {
        alert('Ошибка: ' + (result.error || 'Не удалось дублировать шаг'));
    }
}
</script>
{% endblock %}
